<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ˆéŠSenseå˜›ï½æ„ŸçŸ¥å‹æ™ºæ…§æ—…éŠå¹³å°</title>
    <!-- å¼•å…¥ Tailwind CSS ç¢ºä¿åŸºç¤å…ƒä»¶ç¾è§€èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =======================================================
           ** æº«é¦¨å’–å•¡å»³é¢¨æ ¼ CSS **
           ======================================================= */
        :root {
            --light-bg: #f8f8f8; /* æ·ºè‰²ä¸»èƒŒæ™¯ */
            --paper-bg: #ffffff; /* ç´™å¼µ/å¡ç‰‡èƒŒæ™¯ */
            --accent-cozy: #ffb3b3; /* æº«æš–çš„ç²‰ç´…/è›‹ç³•è‰² */
            --accent-dark: #a87676; /* æº«æš–çš„æ·±è‰²æ–‡å­— */
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
            --gradient-start: #ffe0b2; /* å¥¶æ²¹æ¼¸å±¤èµ·é» */
            --gradient-end: #ffccbc; /* å¥¶æ²¹æ¼¸å±¤çµ‚é» */
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--accent-dark);
            min-height: 100vh;
            padding: 20px;
        }

        /* ä¸»å®¹å™¨å’Œæ’ç‰ˆ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 300px 1fr; /* å´é‚Šæ¬„ + ä¸»å…§å®¹ */
            }
        }

        /* æ¨™é¡Œèˆ‡æŒ‰éˆ• */
        .header-section {
            background-color: var(--paper-bg);
            box-shadow: var(--shadow-soft);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-section h1 {
            color: var(--accent-dark);
            margin: 0;
            font-size: 1.8rem;
        }

        /* å´é‚Šæ¬„ (åƒèœå–®ä¸€æ¨£) */
        .sidebar {
            background-color: var(--paper-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
        }
        .sidebar h2 {
            font-size: 1.25rem;
            color: var(--accent-cozy);
            border-bottom: 2px solid var(--gradient-end);
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        /* è¡¨å–®å…ƒä»¶ */
        .cozy-input, .cozy-select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 15px;
            border: 1px solid #f0e6e6; /* æŸ”å’Œé‚Šæ¡† */
            border-radius: 8px;
            background-color: #fcfcfc;
            color: var(--accent-dark);
            transition: all 0.3s;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .cozy-input:focus, .cozy-select:focus {
            outline: none;
            border-color: var(--accent-cozy);
            box-shadow: 0 0 0 3px rgba(255, 179, 179, 0.3);
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
            color: var(--accent-dark);
        }

        /* æŒ‰éˆ•é¢¨æ ¼ (å¥¶æ²¹æ¼¸å±¤) */
        .cozy-button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            background-image: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            color: var(--accent-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .cozy-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .cozy-button.primary {
            background-image: linear-gradient(45deg, #ff9800, #ff5722); /* æš–æ©˜è‰²å¼·èª¿ */
            color: white;
        }

        /* æ™¯é»å¡ç‰‡å€ (åƒè›‹ç³•é™³åˆ—æ«ƒ) */
        .spot-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: var(--paper-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            min-height: 200px;
        }
        .spot-card {
            background-color: #fffaf0; /* å¥¶æ²¹ç™½è‰² */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255, 179, 179, 0.4); /* ç²‰ç´…æŸ”å’Œé™°å½± */
            padding: 15px;
            border: 1px solid #ffe0b2;
            transition: transform 0.3s;
            position: relative;
            cursor: pointer;
        }
        .spot-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 179, 179, 0.6);
        }
        .spot-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid var(--accent-cozy);
        }
        .add-to-itinerary {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-cozy);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
        }
        
        /* æ™¯é»è©³ç´°èˆ‡åœ°åœ– */
        .spot-detail-map {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .spot-detail-map {
                grid-template-columns: 1fr 1fr;
            }
        }
        .spot-detail, .map-display {
            background-color: var(--paper-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            height: 450px; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´æ›´å¤šå…§å®¹ */
            overflow-y: auto;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #e0f2f1; /* æ·ºç¶ è‰²ä½”ä½ç¬¦ */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6d4c41;
            font-weight: bold;
        }
        
        /* Loading Indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            font-weight: bold;
            color: var(--accent-dark);
            z-index: 50;
        }
        
        /* Weather Card */
        #weatherDisplay {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #90caf9;
        }
        .weather-status {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e88e5;
        }

        /* Modal æ¨£å¼ (ç¶­æŒä¸è®Š) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); padding-top: 50px; }
        .modal-content { margin: 5% auto; width: 90%; max-width: 650px; position: relative; background-color: var(--paper-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-soft); }

    </style>
</head>
<body>

    <!-- æ¨™é¡Œå€ -->
    <header class="header-section">
        <h1>ğŸ° SmartTrip Core - æ™ºæ…§æ—…éŠå¹³å°</h1>
        <button id="openPlannerModal" class="cozy-button">ğŸ“ è¦åŠƒ/è‡ªè¨‚è¡Œç¨‹</button>
    </header>

    <div class="container">
        <!-- å´é‚Šæ¬„ - APIè¨­å®šã€åŸå¸‚é¸å–®ã€æ’ç¨‹æ¸…å–® -->
        <aside class="sidebar">
            <h2>âš™ï¸ ç³»çµ±èˆ‡æ’ç¨‹</h2>
            
            <!-- API è¨­å®šå€ -->
            <div class="api-setting mb-6">
                <label for="apiKey">Gemini API Keyï¼š</label>
                <input type="password" id="apiKey" class="cozy-input" placeholder="è¼¸å…¥æ‚¨çš„ API Key">
                <button id="validateApiKey" class="cozy-button w-full mb-3">é©—è­‰ä¸¦å„²å­˜</button>
                <p id="apiStatus" class="text-sm font-semibold"></p>
            </div>

            <hr class="border-gray-200 my-4">

            <!-- åŸå¸‚é¸æ“‡èˆ‡æ—¥æœŸè¨­å®šå€ -->
            <div class="city-selection mb-6">
                <label for="citySelect">ğŸŒ é¸æ“‡åŸå¸‚/åœ°å€ï¼š</label>
                <select id="citySelect" class="cozy-select">
                    <option value="">è«‹é¸æ“‡åŸå¸‚</option>
                </select>
                
                <label for="travelDateInput" class="mt-4">ğŸ“… æ—…éŠæ—¥æœŸï¼š</label>
                <input type="date" id="travelDateInput" class="cozy-input" />

                <!-- å¤©æ°£é æ¸¬é¡¯ç¤ºå€ -->
                <div id="weatherDisplay">
                    <h3 class="font-bold text-gray-700 mb-1">ğŸŒ¤ï¸ å¤©æ°£é æ¸¬ (ç•¶åœ°)</h3>
                    <p id="weatherStatus" class="weather-status">è«‹é¸æ“‡åŸå¸‚èˆ‡æ—¥æœŸ</p>
                    <p id="weatherDetails" class="text-sm text-gray-600 mt-1"></p>
                </div>
            </div>

            <!-- æ’ç¨‹æ¸…å–®å€ -->
            <div class="itinerary-planning">
                <h2>ğŸ“‹ å·²é¸æ’ç¨‹æ¸…å–®</h2>
                <div id="itineraryListContainer" class="min-h-10 p-2 bg-white rounded-lg shadow-inner border border-gray-100">
                    <p class="text-xs text-gray-500">é»æ“Šæ™¯é»å¡ç‰‡ä¸Šçš„ '+' è™Ÿæ–°å¢</p>
                </div>
                
                <hr class="border-gray-200 my-4">

                <div class="relative">
                    <button id="generateSchedule" class="cozy-button primary w-full">ğŸš€ AI ç”Ÿæˆæœ€ä½³å‹•ç·š</button>
                    <div id="scheduleLoading" class="loading-overlay">AI æ­£åœ¨è¦åŠƒä¸­...</div>
                </div>
            </div>
            
        </aside>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <section class="main-content">
            
            <!-- æ™¯é»æ¢ç´¢å€ - æŸ¥è©¢æ¡† -->
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ” æ™¯é»æ¢ç´¢èˆ‡å³æ™‚æ¨è–¦</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="spotSearchInput" class="cozy-input m-0 flex-grow" placeholder="æ™¯é»åç¨±ã€ç¾é£Ÿé¤å»³æˆ–æ´»å‹•åç¨± (é¡å¤–æŸ¥è©¢)">
                <button id="searchSpotsBtn" class="cozy-button w-32 primary">æŸ¥è©¢ (AI)</button>
            </div>
            
            <!-- æ™¯é»å¡ç‰‡å€ -->
            <div id="spotsContainer" class="spot-card-grid">
                <p class="text-center col-span-full py-10 text-gray-400">è«‹å…ˆé¸æ“‡å·¦å´åŸå¸‚ï¼ŒAI å°‡è‡ªå‹•ç‚ºæ‚¨æ¨è–¦æ™¯é»ã€‚</p>
            </div>

            <!-- æ™¯é»è³‡è¨Šèˆ‡åœ°åœ–å±•ç¤ºå€ -->
            <div class="spot-detail-map mt-6">
                <!-- æ™¯é»è³‡è¨Šå±•ç¤ºå€ (AI å°è¦½å…§å®¹) -->
                <div id="spotDetail" class="spot-detail">
                    <h2 class="text-xl font-bold mb-2 text-red-500">ğŸ“– æ™¯é»è³‡è¨Šèˆ‡ AI å°è¦½</h2>
                    <p class="text-gray-500">é»æ“Šä¸Šæ–¹çš„æ™¯é»å¡ç‰‡æŸ¥çœ‹è©³ç´°ä»‹ç´¹ã€åœ°åœ–åº§æ¨™ï¼Œä¸¦æŸ¥çœ‹ AI ç”Ÿæˆçš„åœ–ç‰‡ã€‚</p>
                    <div id="dynamicContent" class="mt-4"></div>
                </div>

                <!-- åœ°åœ–å±•ç¤ºå€ (å‹•ç·šè¦–è¦ºåŒ–) -->
                <div id="mapDisplay" class="map-display">
                    <h2 class="text-xl font-bold mb-2 text-red-500">ğŸ§­ å‹•ç·šèˆ‡åœ°åœ–</h2>
                    <div id="map">
                        åœ°åœ– API ä½”ä½å€ (é¡¯ç¤ºæ™¯é»å®šä½æˆ–æ’ç¨‹å‹•ç·š)
                    </div>
                </div>
            </div>

            <!-- å¿ƒå¢ƒå›é¥‹å€ (å‹•æ…‹èª¿æ•´è¡Œç¨‹) -->
            <div class="py-4 mt-6 p-4 rounded-xl shadow-lg" style="background-color: #fff0f5;">
                <h3 class="text-lg font-bold mb-3 text-pink-600">ğŸ’– å³æ™‚å¿ƒå¢ƒå›é¥‹ (ç”¨æ–¼å‹•æ…‹èª¿æ•´)</h3>
                <div class="flex flex-wrap gap-3">
                    <button class="cozy-button" onclick="sendFeedback('tired')">ğŸ˜« æœ‰é»ç´¯</button>
                    <button class="cozy-button" onclick="sendFeedback('photo')">ğŸ“¸ æƒ³æ‹ç…§</button>
                    <button class="cozy-button" onclick="sendFeedback('relax')">ğŸ˜Œ æƒ³æ”¾é¬†</button>
                    <button class="cozy-button" onclick="sendFeedback('hungry')">ğŸ• è‚šå­é¤“äº†</button>
                </div>
                <p id="feedbackStatus" class="text-sm mt-3 text-gray-600"></p>
            </div>

        </section>
    </div>

    <!-- è¦åŠƒ/è‡ªè¨‚è¡Œç¨‹ Modal è¡¨å–® -->
    <div id="plannerModal" class="modal">
        <div class="modal-content">
            <span class="close-button absolute top-3 right-5 text-gray-500 hover:text-red-500 cursor-pointer text-2xl">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ğŸ“ æ—…éŠè¦åŠƒèˆ‡è‡ªè¨‚</h2>
            
            <form id="plannerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div class="col-span-full">
                    <label for="planCity">åŸå¸‚åç¨±ï¼š</label>
                    <input type="text" id="planCity" required class="cozy-input" placeholder="è«‹å¡«å¯«åŸå¸‚å…¨åï¼Œä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚">
                </div>

                <div>
                    <label for="planDays">éŠç©å¤©æ•¸ï¼š</label>
                    <input type="number" id="planDays" required class="cozy-input" min="1" value="3">
                </div>

                <div>
                    <label for="planStyle">æ—…éŠé¢¨æ ¼ï¼š</label>
                    <select id="planStyle" required class="cozy-select">
                        <option value="cultural">æ–‡åŒ–æ·±åº¦</option>
                        <option value="adventure">æˆ¶å¤–æ¢éšª</option>
                        <option value="leisure">è¼•é¬†æ…¢æ´»</option>
                        <option value="foodie">ç¾é£Ÿæ¢ç´¢</option>
                    </select>
                </div>

                <hr class="col-span-full my-3 border-gray-200">

                <h3 class="col-span-full text-lg font-semibold text-gray-600">æ–°å¢æ™¯é» (åˆ°ç›®å‰çš„åŸå¸‚)</h3>

                <div>
                    <label for="newSpotName">æ™¯é»åç¨±ï¼š</label>
                    <input type="text" id="newSpotName" class="cozy-input" placeholder="ä¾‹å¦‚ï¼šæ•…å®®åšç‰©é™¢">
                </div>
                
                <div>
                    <label for="newSpotCoords">åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)ï¼š</label>
                    <input type="text" id="newSpotCoords" class="cozy-input" placeholder="ä¾‹å¦‚ï¼š25.1017, 121.5484">
                </div>
                
                <div class="col-span-full">
                    <button type="button" id="addNewSpot" class="cozy-button w-full">ï¼‹ æ–°å¢æ™¯é»è‡³åŸå¸‚è³‡æ–™</button>
                </div>
                
                <div class="col-span-full mt-4">
                    <h3 class="font-semibold mb-2">å·²å„²å­˜åŸå¸‚åˆ—è¡¨</h3>
                    <ul id="cityListDisplay" class="text-sm list-disc pl-5">
                        <!-- åŸå¸‚åˆ—è¡¨å°‡å‹•æ…‹é¡¯ç¤º -->
                    </ul>
                </div>

            </form>
        </div>
    </div>

    <script type="module">
        // =======================================================
        // ** æ ¸å¿ƒæ•¸æ“šçµæ§‹èˆ‡ LocalStorage ç®¡ç† **
        // =======================================================
        const LOCAL_STORAGE_KEY = 'smartTripCoreData';
        
        // å°ç£ç¸£å¸‚åˆ—è¡¨
        const TAIWAN_CITIES = {
            'TPE': { name: 'è‡ºåŒ—å¸‚', days: 3, style: 'cultural', spots: [{ name: 'å°åŒ— 101', coords: '25.0330, 121.5654', intro: '', imgUrl: 'placeholder' }]},
            'NTP': { name: 'æ–°åŒ—å¸‚', days: 3, style: 'adventure', spots: [{ name: 'ä¹ä»½è€è¡—', coords: '25.1092, 121.8488', intro: '', imgUrl: 'placeholder' }]},
            'TYC': { name: 'æ¡ƒåœ’å¸‚', days: 2, style: 'leisure', spots: [{ name: 'Xpark æ°´æ—é¤¨', coords: '25.0116, 121.2238', intro: '', imgUrl: 'placeholder' }]},
            'TXG': { name: 'è‡ºä¸­å¸‚', days: 3, style: 'foodie', spots: [{ name: 'è‡ºä¸­åœ‹å®¶æ­ŒåŠ‡é™¢', coords: '24.1627, 120.6409', intro: '', imgUrl: 'placeholder' }]},
            'TNN': { name: 'è‡ºå—å¸‚', days: 4, style: 'cultural', spots: [{ name: 'èµ¤å´æ¨“', coords: '22.9972, 120.2038', intro: '', imgUrl: 'placeholder' }]},
            'KHH': { name: 'é«˜é›„å¸‚', days: 3, style: 'leisure', spots: [{ name: 'é§äºŒè—è¡“ç‰¹å€', coords: '22.6225, 120.2831', intro: '', imgUrl: 'placeholder' }]},
            'KLC': { name: 'åŸºéš†å¸‚', days: 1, style: 'foodie', spots: [{ name: 'åŸºéš†å»Ÿå£å¤œå¸‚', coords: '25.1322, 121.7456', intro: '', imgUrl: 'placeholder' }]},
            'HSC': { name: 'æ–°ç«¹å¸‚', days: 2, style: 'cultural', spots: [{ name: 'æ–°ç«¹åŸéšå»Ÿ', coords: '24.8055, 120.9675', intro: '', imgUrl: 'placeholder' }]},
            'HSZ': { name: 'æ–°ç«¹ç¸£', days: 2, style: 'adventure', spots: [{ name: 'å…§ç£è€è¡—', coords: '24.7088, 121.1969', intro: '', imgUrl: 'placeholder' }]},
            'MLI': { name: 'è‹—æ —ç¸£', days: 2, style: 'leisure', spots: [{ name: 'ä¸‰ç¾©æœ¨é›•åšç‰©é¤¨', coords: '24.3806, 120.7634', intro: '', imgUrl: 'placeholder' }]},
            'CHW': { name: 'å½°åŒ–ç¸£', days: 2, style: 'cultural', spots: [{ name: 'é¹¿æ¸¯å°é®', coords: '24.0537, 120.4357', intro: '', imgUrl: 'placeholder' }]},
            'NTO': { name: 'å—æŠ•ç¸£', days: 3, style: 'adventure', spots: [{ name: 'æ—¥æœˆæ½­', coords: '23.8967, 120.9123', intro: '', imgUrl: 'placeholder' }]},
            'YLH': { name: 'é›²æ—ç¸£', days: 2, style: 'foodie', spots: [{ name: 'åŒ—æ¸¯æœå¤©å®®', coords: '23.5759, 120.3013', intro: '', imgUrl: 'placeholder' }]},
            'CYI': { name: 'å˜‰ç¾©å¸‚', days: 1, style: 'cultural', spots: [{ name: 'å˜‰ç¾©é˜¿é‡Œå±±', coords: '23.5100, 120.8143', intro: '', imgUrl: 'placeholder' }]},
            'CYC': { name: 'å˜‰ç¾©ç¸£', days: 2, style: 'adventure', spots: [{ name: 'é«˜è·Ÿé‹æ•™å ‚', coords: '23.4735, 120.1557', intro: '', imgUrl: 'placeholder' }]},
            'PFT': { name: 'å±æ±ç¸£', days: 3, style: 'leisure', spots: [{ name: 'å¢¾ä¸åœ‹å®¶å…¬åœ’', coords: '21.9463, 120.7937', intro: '', imgUrl: 'placeholder' }]},
            'ILA': { name: 'å®œè˜­ç¸£', days: 2, style: 'relax', spots: [{ name: 'æ¸…æ°´åœ°ç†±å…¬åœ’', coords: '24.6300, 121.7100', intro: '', imgUrl: 'placeholder' }]},
            'HLN': { name: 'èŠ±è“®ç¸£', days: 3, style: 'adventure', spots: [{ name: 'å¤ªé­¯é–£åœ‹å®¶å…¬åœ’', coords: '24.1609, 121.6373', intro: '', imgUrl: 'placeholder' }]},
            'TTT': { name: 'è‡ºæ±ç¸£', days: 3, style: 'leisure', spots: [{ name: 'ä¼¯æœ—å¤§é“', coords: '23.0900, 121.2100', intro: '', imgUrl: 'placeholder' }]},
            'PNH': { name: 'æ¾æ¹–ç¸£', days: 3, style: 'adventure', spots: [{ name: 'ä¸ƒç¾é›™å¿ƒçŸ³æ»¬', coords: '23.2384, 119.4184', intro: '', imgUrl: 'placeholder' }]},
            'KMN': { name: 'é‡‘é–€ç¸£', days: 2, style: 'cultural', spots: [{ name: 'è’å…‰æ¨“', coords: '24.4285, 118.3184', intro: '', imgUrl: 'placeholder' }]},
            'LCH': { name: 'é€£æ±Ÿç¸£(é¦¬ç¥–)', days: 2, style: 'adventure', spots: [{ name: 'æ±å¼•ç‡ˆå¡”', coords: '26.3768, 120.4907', intro: '', imgUrl: 'placeholder' }]}
        };
        
        let config = {
            apiKey: '',
            currentCityKey: '',
            currentDate: '', // æ–°å¢æ—…éŠæ—¥æœŸç‹€æ…‹
            itinerary: [],
            cities: TAIWAN_CITIES 
        };

        function saveConfig() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
                apiKey: config.apiKey,
                cities: config.cities,
                itinerary: config.itinerary
            }));
            renderItineraryList();
            renderCitySelect();
            renderCityListDisplay();
        }

        function loadConfig() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                const data = JSON.parse(storedData);
                config.apiKey = data.apiKey || '';
                config.cities = { ...TAIWAN_CITIES, ...data.cities };
                config.itinerary = data.itinerary || [];
            }
            document.getElementById('apiKey').value = config.apiKey;
            if (config.apiKey) {
                document.getElementById('apiStatus').textContent = 'API Key å·²è¼‰å…¥ (æœªé©—è­‰)';
                document.getElementById('apiStatus').style.color = 'orange';
            }

            // åˆå§‹åŒ–æ—…éŠæ—¥æœŸç‚ºä»Šæ—¥
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // æœˆä»½å¾ 0 é–‹å§‹
            const dd = String(today.getDate()).padStart(2, '0');
            config.currentDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById('travelDateInput').value = config.currentDate;
        }
        
        // =======================================================
        // ** UI æ¸²æŸ“åŠŸèƒ½ **
        // =======================================================

        // æ¸²æŸ“åŸå¸‚é¸å–®
        const citySelect = document.getElementById('citySelect');
        function renderCitySelect() {
            citySelect.innerHTML = '<option value="">è«‹é¸æ“‡åŸå¸‚</option>';
            const sortedCityKeys = Object.keys(config.cities).sort((a, b) => config.cities[a].name.localeCompare(config.cities[b].name, 'zh-TW'));
            
            sortedCityKeys.forEach(key => {
                const city = config.cities[key];
                const option = new Option(city.name, key);
                citySelect.add(option);
            });
            citySelect.value = config.currentCityKey;
        }

        // æ¸²æŸ“æ™¯é»å¡ç‰‡
        const spotsContainer = document.getElementById('spotsContainer');
        function renderSpotCards(spots = [], isSearchResults = false, cityKey = '') {
            spotsContainer.innerHTML = '';
            
            if (spots.length === 0) {
                spotsContainer.innerHTML = `<p class="text-center col-span-full py-10 text-gray-400">
                    ${isSearchResults ? 'æ‰¾ä¸åˆ°ç›¸é—œæ™¯é»ã€‚' : 'è«‹å…ˆé¸æ“‡å·¦å´åŸå¸‚ï¼ŒAI å°‡è‡ªå‹•ç‚ºæ‚¨æ¨è–¦æ™¯é»ã€‚'}
                </p>`;
                return;
            }

            spots.forEach((spot, index) => {
                const uniqueId = `${cityKey}-${index}-${spot.name}`;
                
                const card = document.createElement('div');
                card.className = 'spot-card';
                card.innerHTML = `
                    <img src="https://placehold.co/400x180/ffccbc/a87676?text=${spot.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x180/ffccbc/a87676?text=${spot.name}';">
                    <h3 class="text-lg font-bold text-gray-800 mb-1">${spot.name}</h3>
                    <p class="text-sm text-gray-600 truncate">${spot.intro || 'é»æ“ŠæŸ¥çœ‹ AI ç”Ÿæˆçš„ä»‹ç´¹...'}</p>
                    <button class="add-to-itinerary" data-unique-id="${uniqueId}" data-spot-name="${spot.name}" data-coords="${spot.coords || '25.0000, 121.0000'}">+</button>
                `;
                card.addEventListener('click', () => displaySpotDetail(spot));
                spotsContainer.appendChild(card);
            });
        }

        // æ¸²æŸ“å·²é¸æ’ç¨‹æ¸…å–® (é‚è¼¯ä¸è®Š)
        const itineraryListContainer = document.getElementById('itineraryListContainer');
        function renderItineraryList() {
            itineraryListContainer.innerHTML = '';
            if (config.itinerary.length === 0) {
                itineraryListContainer.innerHTML = '<p class="text-xs text-gray-500">é»æ“Šæ™¯é»å¡ç‰‡ä¸Šçš„ '+' è™Ÿæ–°å¢</p>';
                return;
            }

            config.itinerary.forEach((item, index) => {
                const cityName = config.cities[item.cityKey]?.name || 'æœªçŸ¥åŸå¸‚';
                const listItem = document.createElement('div');
                listItem.className = 'itinerary-item flex justify-between items-center p-2 my-1 bg-white rounded-md shadow-sm border border-gray-100';
                listItem.innerHTML = `
                    <span class="font-semibold text-sm">${index + 1}. ${item.name} (${cityName})</span>
                    <button data-index="${index}" class="text-red-500 hover:text-red-700 font-bold text-lg leading-none" onclick="removeFromItinerary(${index})">Ã—</button>
                `;
                itineraryListContainer.appendChild(listItem);
            });
        }

        // é¡¯ç¤ºæ™¯é»è©³ç´°è³‡è¨Š (é‚è¼¯ä¸è®Š)
        function displaySpotDetail(spot) {
            const detailElement = document.getElementById('dynamicContent');
            const mapElement = document.getElementById('map');
            
            const currentCityKey = spot.cityKey || config.currentCityKey || Object.keys(config.cities)[0];

            detailElement.innerHTML = `
                <h3 class="text-xl font-bold text-gray-700">${spot.name}</h3>
                <p class="text-sm text-gray-500 mb-3">åŸå¸‚: ${config.cities[currentCityKey]?.name || 'æœªçŸ¥'} | åº§æ¨™ï¼š${spot.coords}</p>
                <p class="mb-4">${spot.intro || 'é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨ç”Ÿæˆå°è¦½å…§å®¹...'}</p>
                <div class="flex flex-col md:flex-row gap-3">
                    <button class="cozy-button w-full" onclick="generateContentAndImage('${currentCityKey}', '${spot.name}')">âœ¨ ç”Ÿæˆä»‹ç´¹èˆ‡åœ–ç‰‡</button>
                    <button class="cozy-button w-full primary" onclick="speakContent('${spot.name}', '${spot.intro}')">ğŸ”Š æ’­æ”¾èªéŸ³å°è¦½</button>
                </div>
                <div class="mt-4 p-3 bg-white rounded-lg border border-gray-100" id="generatedImageContainer">
                    <p class="text-center text-sm text-gray-400">åœ–ç‰‡å°‡åœ¨æ­¤è™•é¡¯ç¤º...</p>
                    <img id="generatedImage" src="" style="display:none; width:100%; height:auto; border-radius: 8px;" alt="AI ç”Ÿæˆæ™¯é»åœ–ç‰‡">
                </div>
            `;
            
            mapElement.innerHTML = `
                <p class="text-center font-bold text-lg">å®šä½ï¼š${spot.name}</p>
                <p class="text-center text-sm">(${spot.coords})</p>
                <p class="text-center text-xs mt-2 text-red-500">æ­¤ç‚ºä½”ä½ç¬¦ï¼Œå¯¦éš›åœ°åœ–éœ€ä¸²æ¥åœ°åœ– APIã€‚</p>
            `;
        }
        
        // =======================================================
        // ** æ ¸å¿ƒäº’å‹•é‚è¼¯ **
        // =======================================================

        // é»é¸åŸå¸‚/æ—¥æœŸæ”¹è®Šæ™‚çš„ç¸½è™•ç†å‡½æ•¸ (UPDATED)
        citySelect.addEventListener('change', (e) => {
            config.currentCityKey = e.target.value;
            if (config.currentCityKey) {
                fetchWeatherForecast();
                fetchCityRecommendations();
            } else {
                spotsContainer.innerHTML = '<p class="text-center col-span-full py-10 text-gray-400">è«‹å…ˆé¸æ“‡å·¦å´åŸå¸‚ï¼ŒAI å°‡è‡ªå‹•ç‚ºæ‚¨æ¨è–¦æ™¯é»ã€‚</p>';
                document.getElementById('weatherStatus').textContent = 'è«‹é¸æ“‡åŸå¸‚èˆ‡æ—¥æœŸ';
                document.getElementById('weatherDetails').textContent = '';
            }
        });
        
        document.getElementById('travelDateInput').addEventListener('change', (e) => {
            config.currentDate = e.target.value;
            if (config.currentCityKey) {
                fetchWeatherForecast();
                // æ—¥æœŸæ”¹è®Šä¹Ÿæ‡‰è©²å½±éŸ¿æ¨è–¦é‚è¼¯
                fetchCityRecommendations();
            }
        });


        // é»æ“ŠæŸ¥è©¢æŒ‰éˆ• (ç”¨æ–¼é¡å¤–æŸ¥è©¢)
        document.getElementById('searchSpotsBtn').addEventListener('click', () => {
            const query = document.getElementById('spotSearchInput').value.trim();
            if (query) {
                searchSpots(query);
            } else {
                alertMessage('âš ï¸ è«‹è¼¸å…¥æŸ¥è©¢é—œéµå­—ï¼ˆæ™¯é»æˆ–ç¾é£Ÿï¼‰ï¼', 'orange');
            }
        });
        document.getElementById('spotSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = document.getElementById('spotSearchInput').value.trim();
                if (query) {
                    searchSpots(query);
                } else {
                    alertMessage('âš ï¸ è«‹è¼¸å…¥æŸ¥è©¢é—œéµå­—ï¼ˆæ™¯é»æˆ–ç¾é£Ÿï¼‰ï¼', 'orange');
                }
            }
        });

        // å¾æ’ç¨‹ä¸­ç§»é™¤ (é‚è¼¯ä¸è®Š)
        window.removeFromItinerary = (index) => {
            config.itinerary.splice(index, 1);
            saveConfig();
            alertMessage('æ™¯é»å·²å¾æ’ç¨‹æ¸…å–®ç§»é™¤ã€‚', 'red');
        }

        // =======================================================
        // ** AI æ ¸å¿ƒé‚è¼¯ - æ¨è–¦ã€å¤©æ°£èˆ‡æŸ¥è©¢ **
        // =======================================================

        /**
         * å‘¼å« Gemini API é€²è¡ŒåŸå¸‚æ¨è–¦ (åŸå¸‚é¸æ“‡å¾Œè‡ªå‹•è§¸ç™¼)
         */
        async function fetchCityRecommendations() {
            if (!config.apiKey || !config.currentCityKey) {
                renderSpotCards([], false);
                return;
            }
            
            const city = config.cities[config.currentCityKey];
            const date = config.currentDate;
            
            spotsContainer.innerHTML = `<p class="text-center col-span-full py-10 text-orange-500 font-bold">â³ AI æ­£åœ¨çµåˆå³æ™‚è§€å…‰æ•¸æ“šæ¨è–¦ ${city.name} çš„æ™¯é»...</p>`;

            const userQuery = `æˆ‘åœ¨å°ç£ ${city.name} æ—…éŠï¼Œæ—¥æœŸæ˜¯ ${date}ã€‚è«‹æ ¹æ“šæœ€æ–°çš„è§€å…‰æ•¸æ“šï¼ˆä¾‹å¦‚äººæµã€æ´»å‹•ã€å¤©æ°£è€ƒé‡ï¼‰ï¼Œæ¨è–¦ 5 å€‹æœ€ç›¸é—œã€ä¸”æœ€ç¬¦åˆã€Œ${city.style}ã€é¢¨æ ¼çš„ç†±é–€åœ°é»ã€‚è«‹æä¾›åœ°é»åç¨±ã€ç°¡çŸ­ä»‹ç´¹ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œä»¥åŠç›¡å¯èƒ½æº–ç¢ºçš„åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)ã€‚`;
            const systemPrompt = "æ‚¨æ˜¯ SmartTrip Core AI æ¢ç´¢å¼•æ“ï¼Œå°ˆé–€æ ¹æ“šå¯¦æ™‚è³‡è¨Šï¼ˆå¦‚è§€å…‰ç½²é–‹æ”¾è³‡æ–™ï¼‰å’Œæ—…éŠæ—¥æœŸé€²è¡Œæ™ºæ…§æ¨è–¦ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œåš´æ ¼çš„ JSON æ ¼å¼å›è¦†ã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recommendations": {
                                "type": "ARRAY",
                                "description": "æ¨è–¦åœ°é»åˆ—è¡¨",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING", "description": "åœ°é»åç¨±" },
                                        "intro": { "type": "STRING", "description": "ç°¡çŸ­çš„ç¹é«”ä¸­æ–‡ä»‹ç´¹" },
                                        "coords": { "type": "STRING", "description": "åº§æ¨™ (ç·¯åº¦, ç¶“åº¦), ä¾‹å¦‚: 25.0330, 121.5654" }
                                    },
                                    "propertyOrdering": ["name", "intro", "coords"]
                                }
                            }
                        }
                    }
                }
            };
            
            await fetchGeminiApi(payload, (result) => {
                try {
                    const jsonResponse = JSON.parse(result.text);
                    if (jsonResponse.recommendations && jsonResponse.recommendations.length > 0) {
                        const spots = jsonResponse.recommendations.map(s => ({ ...s, cityKey: config.currentCityKey }));
                        renderSpotCards(spots, true, config.currentCityKey);
                    } else {
                        renderSpotCards([], true);
                    }
                } catch (e) {
                    alertMessage(`âŒ AI æ¨è–¦è§£æå¤±æ•—ã€‚éŒ¯èª¤: ${e.message}`, 'red');
                    console.error('AI Recommendations failed:', e);
                }
            });
        }


        /**
         * å‘¼å« Gemini API é€²è¡Œå¤©æ°£æŸ¥è©¢ (åŸå¸‚/æ—¥æœŸæ”¹è®Šå¾Œè‡ªå‹•è§¸ç™¼)
         */
        async function fetchWeatherForecast() {
            const city = config.cities[config.currentCityKey]?.name;
            const date = config.currentDate;
            const weatherStatusEl = document.getElementById('weatherStatus');
            const weatherDetailsEl = document.getElementById('weatherDetails');

            if (!config.apiKey) {
                weatherStatusEl.textContent = 'è«‹å…ˆè¨­å®š API Key æ‰èƒ½æŸ¥è©¢å¤©æ°£ã€‚';
                weatherDetailsEl.textContent = '';
                return;
            }
            if (!city || !date) return;

            weatherStatusEl.textContent = 'â³ æ­£åœ¨æŸ¥è©¢å¤©æ°£é å ±...';
            weatherDetailsEl.textContent = '';
            
            const userQuery = `è«‹æŸ¥è©¢å°ç£ ${city} åœ¨ ${date} çš„å¤©æ°£é å ±ã€‚è«‹æä¾›ä¸€å€‹ç°¡æ½”çš„ä¸­æ–‡æ‘˜è¦ï¼ˆä¾‹å¦‚ï¼šå¤šé›²æ™‚æ™´ï¼Œé™é›¨æ©Ÿç‡ 30%ï¼‰ä»¥åŠè©³ç´°çš„æº«åº¦ç¯„åœå’Œæ—…è¡Œæ³¨æ„äº‹é …ã€‚`;
            const systemPrompt = "æ‚¨æ˜¯ SmartTrip æ°£è±¡æ¨¡æ“¬ AIã€‚è«‹å‹™å¿…æ ¹æ“š Google Search çš„æœ€æ–°è³‡è¨Šï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œåš´æ ¼çš„ JSON æ ¼å¼å›è¦†ã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary_tw": { "type": "STRING", "description": "å¤©æ°£ç°¡æ½”æ‘˜è¦ï¼Œä¾‹å¦‚ï¼šå¤šé›²æ™‚æ™´" },
                            "details_tw": { "type": "STRING", "description": "è©³ç´°è³‡è¨Šï¼ŒåŒ…å«æº«åº¦ã€é™é›¨æ©Ÿç‡èˆ‡æ—…è¡Œæ³¨æ„äº‹é …" },
                            "icon": { "type": "STRING", "description": "å¤©æ°£åœ–æ¨™ï¼ˆä¾‹å¦‚ï¼šâ˜€ï¸, ğŸŒ§ï¸, â˜ï¸ï¼‰" }
                        },
                        "propertyOrdering": ["icon", "summary_tw", "details_tw"]
                    }
                }
            };
            
            await fetchGeminiApi(payload, (result) => {
                try {
                    const jsonResponse = JSON.parse(result.text);
                    weatherStatusEl.textContent = `${jsonResponse.icon} ${jsonResponse.summary_tw}`;
                    weatherDetailsEl.textContent = jsonResponse.details_tw;
                } catch (e) {
                    weatherStatusEl.textContent = 'âŒ å¤©æ°£æŸ¥è©¢å¤±æ•— (è§£æéŒ¯èª¤)';
                    weatherDetailsEl.textContent = e.message;
                    console.error('AI Weather failed:', e);
                }
            });
        }


        /**
         * å‘¼å« Gemini API é€²è¡Œæ™¯é»/ç¾é£Ÿæœå°‹ (ä½¿ç”¨è€…æ‰‹å‹•æŸ¥è©¢)
         */
        async function searchSpots(query) {
            if (!config.apiKey) {
                alertMessage('âŒ è«‹å…ˆåœ¨è¨­å®šå€è¼¸å…¥ä¸¦é©—è­‰ Gemini API Keyï¼', 'red');
                return;
            }
            
            const city = config.cities[config.currentCityKey];
            
            spotsContainer.innerHTML = `<p class="text-center col-span-full py-10 text-orange-500 font-bold">â³ SmartTrip AI æ­£åœ¨çµåˆå³æ™‚è³‡è¨Šæœå°‹ã€Œ${query}ã€...</p>`;

            const userQuery = `æˆ‘åœ¨å°ç£ ${city.name} æ—…éŠï¼Œæ—¥æœŸæ˜¯ ${config.currentDate}ã€‚æˆ‘æƒ³æ‰¾é—œæ–¼ã€Œ${query}ã€çš„æ™¯é»ã€ç¾é£Ÿæˆ–æ´»å‹•è³‡è¨Šã€‚è«‹æ ¹æ“šæœ€æ–°çš„è§€å…‰æ•¸æ“šï¼ˆä¾‹å¦‚äººæµã€æ´»å‹•ã€å¤©æ°£è€ƒé‡ï¼‰ï¼Œæ¨è–¦ 3 åˆ° 5 å€‹æœ€ç›¸é—œçš„åœ°é»ã€‚è«‹æä¾›åœ°é»åç¨±ã€ä¸€å€‹ç°¡çŸ­çš„ä»‹ç´¹ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œä»¥åŠç›¡å¯èƒ½æº–ç¢ºçš„åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)ã€‚`;
            const systemPrompt = "æ‚¨æ˜¯ SmartTrip Core AI æ¢ç´¢å¼•æ“ï¼Œå°ˆé–€æ ¹æ“šå¯¦æ™‚è³‡è¨Šï¼ˆå¦‚è§€å…‰ç½²é–‹æ”¾è³‡æ–™ï¼‰é€²è¡Œæ™ºæ…§æ¨è–¦ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œåš´æ ¼çš„ JSON æ ¼å¼å›è¦†ã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recommendations": {
                                "type": "ARRAY",
                                "description": "æ¨è–¦åœ°é»åˆ—è¡¨",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING", "description": "åœ°é»åç¨±" },
                                        "intro": { "type": "STRING", "description": "ç°¡çŸ­çš„ç¹é«”ä¸­æ–‡ä»‹ç´¹" },
                                        "coords": { "type": "STRING", "description": "åº§æ¨™ (ç·¯åº¦, ç¶“åº¦), ä¾‹å¦‚: 25.0330, 121.5654" }
                                    },
                                    "propertyOrdering": ["name", "intro", "coords"]
                                }
                            }
                        }
                    }
                }
            };
            
            await fetchGeminiApi(payload, (result) => {
                try {
                    const jsonResponse = JSON.parse(result.text);
                    if (jsonResponse.recommendations && jsonResponse.recommendations.length > 0) {
                        const spots = jsonResponse.recommendations.map(s => ({ ...s, cityKey: config.currentCityKey }));
                        renderSpotCards(spots, true, config.currentCityKey);
                    } else {
                        renderSpotCards([], true);
                    }
                } catch (e) {
                    alertMessage(`âŒ AI æŸ¥è©¢è§£æå¤±æ•—ã€‚éŒ¯èª¤: ${e.message}`, 'red');
                    console.error('AI Search failed:', e);
                }
            });
        }


        /**
         * çµ±ä¸€çš„ Gemini API å‘¼å«å‡½æ•¸ï¼ˆåŒ…å«é‡è©¦æ©Ÿåˆ¶ï¼‰(é‚è¼¯ä¸è®Š)
         */
        async function fetchGeminiApi(payload, callback) {
            const apiKey = config.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const MAX_RETRIES = 3;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }

                    if (!response.ok) {
                        throw new Error(`API éŒ¯èª¤: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        callback({ text: candidate.content.parts[0].text });
                        return;
                    } else {
                        throw new Error('AI å›è¦†å…§å®¹ç‚ºç©ºæˆ–çµæ§‹ä¸æ­£ç¢ºã€‚');
                    }

                } catch (error) {
                    if (i === MAX_RETRIES - 1) {
                         alertMessage(`âŒ æœ€çµ‚ API å‘¼å«å¤±æ•—: ${error.message}`, 'red');
                    }
                }
            }
        }

        // =======================================================
        // ** å•Ÿå‹•èˆ‡å…¶ä»–åŠŸèƒ½ (ä¸è®Š) **
        // =======================================================
        
        // é»é¸æ™¯é»å¡ç‰‡ä¸Šçš„ + è™Ÿæ–°å¢è‡³æ’ç¨‹ (é‚è¼¯ä¸è®Š)
        spotsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-to-itinerary')) {
                const spotName = e.target.dataset.spotName;
                const coords = e.target.dataset.coords;
                const cityKey = config.currentCityKey;
                
                if (!cityKey) {
                    alertMessage('âš ï¸ è«‹å…ˆé¸æ“‡åŸå¸‚æ‰èƒ½åŠ å…¥æ’ç¨‹ã€‚', 'orange');
                    return;
                }

                if (config.itinerary.some(item => item.name === spotName && item.cityKey === cityKey)) {
                    alertMessage('âš ï¸ æ­¤æ™¯é»å·²åœ¨æ’ç¨‹æ¸…å–®ä¸­ï¼', 'orange');
                    return;
                }

                config.itinerary.push({ 
                    cityKey: cityKey,
                    name: spotName, 
                    coords: coords 
                });
                
                e.target.textContent = 'âœ…';
                e.target.style.backgroundColor = 'green';
                e.target.disabled = true;

                saveConfig();
                alertMessage(`å·²å°‡ ${spotName} åŠ å…¥æ’ç¨‹æ¸…å–®ï¼`, 'green');
            }
        });

        // å•Ÿå‹•æ‡‰ç”¨
        window.onload = () => {
            loadConfig();
            renderCitySelect();
            renderItineraryList();
            
            // å¦‚æœæœ‰é è¨­çš„åŸå¸‚ï¼Œè‡ªå‹•è§¸ç™¼æ¨è–¦å’Œå¤©æ°£æŸ¥è©¢
            if (config.currentCityKey) {
                fetchWeatherForecast();
                fetchCityRecommendations();
            }
        };

        // å…¶ä»–åŠŸèƒ½ (Modal, èªéŸ³, å¿ƒå¢ƒå›é¥‹, API Keyé©—è­‰) ä¿æŒä¸è®Š...
        window.speakContent = (title, content) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(`${title} å°è¦½å…§å®¹ï¼š${content}`);
                const voices = speechSynthesis.getVoices();
                const zhVoice = voices.find(v => v.lang.startsWith('zh-') || v.lang.startsWith('yue-'));
                if (zhVoice) {
                    utterance.voice = zhVoice;
                }
                utterance.lang = 'zh-TW';
                speechSynthesis.speak(utterance);
                alertMessage('ğŸ”Š æ­£åœ¨æ’­æ”¾èªéŸ³å°è¦½...', 'orange');
            } else {
                alertMessage('âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆã€‚', 'red');
            }
        }
        
        window.sendFeedback = (mood) => {
            const feedbackStatus = document.getElementById('feedbackStatus');
            const city = config.cities[config.currentCityKey];
            if (!city) {
                feedbackStatus.textContent = "è«‹å…ˆé¸æ“‡ä¸€å€‹åŸå¸‚ï¼";
                return;
            }
            
            feedbackStatus.textContent = `æ”¶åˆ°æ‚¨çš„å›é¥‹ï¼šã€Œ${mood}ã€ï¼ŒAI æ­£åœ¨æ ¹æ“šå³æ™‚å¤©æ°£/äººæµæ•¸æ“šåŠæ‚¨çš„å¿ƒå¢ƒï¼Œæº–å‚™å»ºè­°ä¸‹ä¸€ç«™...`;
            feedbackStatus.style.color = 'blue';

            setTimeout(() => {
                 feedbackStatus.textContent = `âœ… AI å»ºè­°ï¼šä¸‹ä¸€ç«™æ¨è–¦ã€Œ${mood === 'tired' ? 'é™„è¿‘çš„å’–å•¡å»³ä¼‘æ†©' : mood === 'photo' ? 'æœ€ä½³æ‹ç…§é»' : 'ç•¶å‰è¡Œç¨‹ä¸è®Š'}ã€ã€‚ (å‹•æ…‹èª¿æ•´æ¨¡æ“¬)`;
                 feedbackStatus.style.color = 'green';
            }, 1500);
        }

        const modal = document.getElementById("plannerModal");
        document.getElementById("openPlannerModal").onclick = () => { modal.style.display = "block"; renderCityListDisplay(); }
        document.querySelector(".close-button").onclick = () => { modal.style.display = "none"; }
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } }

        const cityListDisplay = document.getElementById('cityListDisplay');
        function renderCityListDisplay() {
            cityListDisplay.innerHTML = '';
            Object.keys(config.cities).forEach(key => {
                const city = config.cities[key];
                const isDefault = TAIWAN_CITIES[key] !== undefined; 
                const deleteBtn = isDefault ? '' : `<button class="text-xs text-red-500 ml-2" onclick="deleteCity('${key}')">(åˆªé™¤)</button>`;
                
                const li = document.createElement('li');
                li.innerHTML = `${city.name} (${city.spots.length} æ™¯é») ${deleteBtn}`;
                cityListDisplay.appendChild(li);
            });
        }
        window.deleteCity = (cityKey) => {
            if (TAIWAN_CITIES[cityKey]) {
                alertMessage('âŒ é è¨­åŸå¸‚ç„¡æ³•åˆªé™¤ï¼', 'red');
                return;
            }
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åŸå¸‚ ${config.cities[cityKey].name} åŠå…¶æ‰€æœ‰æ™¯é»å—ï¼Ÿ`)) {
                delete config.cities[cityKey];
                config.currentCityKey = '';
                saveConfig();
                renderSpotCards([]); 
            }
        }

        document.getElementById('addNewSpot').addEventListener('click', () => {
            const cityKeyName = document.getElementById('planCity').value.trim();
            const spotName = document.getElementById('newSpotName').value.trim();
            const spotCoords = document.getElementById('newSpotCoords').value.trim();
            
            if (!cityKeyName || !spotName || !spotCoords) {
                alertMessage('âŒ è«‹è¼¸å…¥å®Œæ•´çš„åŸå¸‚ã€æ™¯é»åç¨±å’Œåº§æ¨™ï¼', 'red');
                return;
            }

            let existingKey = Object.keys(config.cities).find(key => config.cities[key].name === cityKeyName);
            if (!existingKey) {
                existingKey = cityKeyName.substring(0, 3).toUpperCase();
                config.cities[existingKey] = {
                    name: cityKeyName,
                    days: parseInt(document.getElementById('planDays').value) || 3,
                    style: document.getElementById('planStyle').value || 'cultural',
                    spots: []
                };
            }

            config.cities[existingKey].spots.push({
                name: spotName,
                coords: spotCoords,
                intro: '',
                imgUrl: 'placeholder'
            });

            saveConfig();
            alertMessage(`âœ… æ™¯é» ${spotName} å·²æ–°å¢è‡³ ${cityKeyName}ï¼`, 'green');
            document.getElementById('newSpotName').value = '';
            document.getElementById('newSpotCoords').value = '';
            
            if (config.currentCityKey === existingKey) {
                 fetchCityRecommendations();
            }
        });
        
        function alertMessage(message, color) {
            const statusElement = document.createElement('div');
            statusElement.className = `fixed top-4 right-4 p-3 rounded-lg shadow-xl font-bold z-50 text-white`;
            statusElement.style.backgroundColor = color === 'green' ? '#4CAF50' : 
                                                  color === 'red' ? '#F44336' : 
                                                  color === 'orange' ? '#FF9800' : 'gray';
            statusElement.textContent = message;
            document.body.appendChild(statusElement);
            setTimeout(() => {
                statusElement.remove();
            }, 3000);
        }

        window.generateContentAndImage = async (cityKey, spotName) => {
             if (!config.apiKey) {
                alertMessage('âŒ è«‹å…ˆåœ¨è¨­å®šå€è¼¸å…¥ä¸¦é©—è­‰ Gemini API Keyï¼', 'red');
                return;
            }

            const city = config.cities[cityKey]?.name || 'æœªçŸ¥åŸå¸‚';
            const detailElement = document.getElementById('dynamicContent');
            const imageContainer = document.getElementById('generatedImageContainer');
            
            detailElement.innerHTML = `<p class="text-orange-500 font-bold mt-2">â³ AI æ­£åœ¨ç‚º ${spotName} æ’°å¯«ä»‹ç´¹èˆ‡ç”Ÿæˆåœ–ç‰‡...</p>`;
            imageContainer.innerHTML = '<p class="text-center text-orange-500">åœ–ç‰‡ç”Ÿæˆä¸­...</p>';

            const userQuery = `ç‚º ${city} çš„ ${spotName} æ™¯é»ï¼Œæ’°å¯«ä¸€ç¯‡ 80 å­—çš„ç°¡æ½”å°è¦½ä»‹ç´¹ã€‚è«‹åŒæ™‚ç‚ºæˆ‘ç”Ÿæˆä¸€å¼µèƒ½ç”¨æ–¼åœ–ç‰‡ç”Ÿæˆæ¨¡å‹ (Image Generation Model) çš„è‹±æ–‡æç¤ºè© (Prompt)ï¼Œæè¿°è©²æ™¯é»åœ¨æ™´æœ—å¤©æ°£ä¸‹çš„ç¾éº—å…¨æ™¯ï¼Œé¢¨æ ¼ç‚ºã€Œæ°´å½©æ’ç•«ã€ã€‚`;
            const systemPrompt = "æ‚¨æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ—…éŠ AI å°éŠã€‚è«‹æ ¹æ“šç”¨æˆ¶è¦æ±‚ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œåš´æ ¼çš„ JSON æ ¼å¼å›è¦†ï¼Œä¸¦åŸºæ–¼æ‚¨æœ€æ–°çš„çŸ¥è­˜åº«ï¼ˆåŒ…å«å¯¦æ™‚è³‡è¨Šï¼‰ä¾†å›ç­”ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "description_tw": { "type": "STRING", "description": "æ™¯é»çš„ç¹é«”ä¸­æ–‡å°è¦½ä»‹ç´¹" },
                            "image_prompt_en": { "type": "STRING", "description": "ç”¨æ–¼ç”Ÿæˆåœ–ç‰‡çš„è‹±æ–‡æç¤ºè©" }
                        },
                        "propertyOrdering": ["description_tw", "image_prompt_en"]
                    }
                }
            };
            
            await fetchGeminiApi(payload, (result) => {
                try {
                    const jsonResponse = JSON.parse(result.text);
                    const newIntro = jsonResponse.description_tw;
                    
                    const spot = { name: spotName, intro: newIntro, coords: 'N/A' };
                    displaySpotDetail(spot); 
                    
                    generateImage(jsonResponse.image_prompt_en);

                } catch (e) {
                    detailElement.innerHTML = `<p class="text-red-500">âŒ AI å›è¦†è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ– JSON æ ¼å¼è¦æ±‚ã€‚éŒ¯èª¤: ${e.message}</p>`;
                }
            });
        }

        async function generateImage(imagePrompt) {
            const imageContainer = document.getElementById('generatedImageContainer');
            imageContainer.innerHTML = '<p class="text-center text-orange-500">ğŸ–¼ï¸ æ­£åœ¨å‘¼å« Imagen 3.0 ç”Ÿæˆåœ–ç‰‡...</p>';
            
            const payload = { 
                instances: [{ prompt: imagePrompt }], 
                parameters: { "sampleCount": 1 } 
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    imageContainer.innerHTML = `<img src="${imageUrl}" style="width:100%; height:auto; border-radius: 8px;" alt="AI Generated Image">`;
                    alertMessage('âœ… åœ–ç‰‡å·²æˆåŠŸç”Ÿæˆï¼', 'green');
                } else {
                    throw new Error('åœ–ç‰‡ç”Ÿæˆçµæœçµæ§‹éŒ¯èª¤æˆ–ç„¡åœ–ç‰‡æ•¸æ“šã€‚');
                }
            } catch (error) {
                imageContainer.innerHTML = `<p class="text-red-500">âŒ åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ${error.message}</p>`;
            }
        }

        document.getElementById('generateSchedule').addEventListener('click', async () => {
            if (config.itinerary.length < 2) {
                alertMessage('âš ï¸ è«‹å…ˆé¸æ“‡è‡³å°‘å…©å€‹æ™¯é»åŠ å…¥æ’ç¨‹æ¸…å–®ï¼', 'orange');
                return;
            }
            if (!config.apiKey) {
                alertMessage('âŒ è«‹å…ˆåœ¨è¨­å®šå€è¼¸å…¥ä¸¦é©—è­‰ Gemini API Keyï¼', 'red');
                return;
            }

            const loading = document.getElementById('scheduleLoading');
            loading.style.display = 'flex';
            const cityKey = config.itinerary[0].cityKey;
            const city = config.cities[cityKey];

            const itineraryDetails = config.itinerary.map((item, index) => 
                `${index + 1}. æ™¯é»åç¨±: ${item.name}, åº§æ¨™: ${item.coords}`
            ).join('\n');
            
            const userQuery = `è«‹ä½ æ‰®æ¼” SmartTrip Core AI æ™ºæ…§æ’ç¨‹å¼•æ“ã€‚ç›®å‰æ—…éŠåŸå¸‚æ˜¯ ${city.name}ï¼Œæ—…éŠé¢¨æ ¼æ˜¯ ${city.style}ï¼ŒéŠç©å¤©æ•¸ç‚º ${city.days} å¤©ï¼Œæ—¥æœŸæ˜¯ ${config.currentDate}ã€‚è«‹æ ¹æ“šä»¥ä¸‹å·²é¸æ™¯é»ï¼Œçµåˆ**å¯¦æ™‚äº¤é€šã€äººæµç‹€æ…‹å’Œç•¶å‰å¤©æ°£è³‡è¨Š**ï¼Œç‚ºæˆ‘ç”Ÿæˆä¸€ä»½æœ€é †æš¢ã€æœ€è²¼å¿ƒçš„ä¸€æ—¥æ—…éŠå‹•ç·šæ’ç¨‹ã€‚
            
            å·²é¸æ™¯é»æ¸…å–®: \n${itineraryDetails}
            
            è«‹ç¢ºä¿å›è¦†çš„ JSON ä¸­åŒ…å«æœ€ä½³çš„è¨ªå•é †åºï¼Œä¸¦ç‚ºæ¯å€‹æ™¯é»æä¾›ç°¡æ½”çš„**å‹•ç·šå»ºè­°åŸå› **ï¼ˆéœ€è€ƒæ…®äººæµã€äº¤é€šã€é¢¨æ ¼åå¥½ï¼‰ã€‚`;
            
            const systemPrompt = "æ‚¨æ˜¯ä¸€å€‹å°ˆæ¥­çš„ AI æ’ç¨‹å™¨ã€‚è«‹æ ¹æ“šç”¨æˆ¶è¦æ±‚ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œåš´æ ¼çš„ JSON æ ¼å¼å›è¦†ï¼Œä¸¦å‹™å¿…åŸºæ–¼å¯¦æ™‚è³‡è¨Šå’Œå„ªåŒ–å‹•ç·šåŸå‰‡ä¾†å›ç­”ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "city_name": { "type": "STRING" },
                            "travel_style": { "type": "STRING" },
                            "optimized_itinerary": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "stop_order": { "type": "INTEGER" },
                                        "spot_name": { "type": "STRING" },
                                        "coords": { "type": "STRING" },
                                        "recommendation_reason": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["stop_order", "spot_name", "coords", "recommendation_reason"]
                                }
                            },
                            "summary": { "type": "STRING", "description": "ç¸½çµæ’ç¨‹çš„å„ªåŒ–åŸå‰‡ï¼Œä¸¦æé†’ç”¨æˆ¶æ³¨æ„å¯¦æ™‚è®Šå‹•ã€‚" }
                        },
                        "propertyOrdering": ["city_name", "travel_style", "optimized_itinerary", "summary"]
                    }
                }
            };

            await fetchGeminiApi(payload, (result) => {
                loading.style.display = 'none';
                try {
                    const schedule = JSON.parse(result.text);
                    displayScheduleResult(schedule);
                } catch (e) {
                    alertMessage(`âŒ æ’ç¨‹ AI å›è¦†è§£æå¤±æ•—ã€‚éŒ¯èª¤: ${e.message}`, 'red');
                    console.error('AI Schedule failed:', e);
                }
            });
        });
        
        function displayScheduleResult(schedule) {
            const mapElement = document.getElementById('map');
            const summaryHTML = `
                <h3 class="text-xl font-bold text-red-500 mb-2">âœ… AI æœ€ä½³å‹•ç·šå·²ç”Ÿæˆï¼</h3>
                <p class="text-sm italic text-gray-600 mb-3">åŸå¸‚: ${schedule.city_name} | é¢¨æ ¼: ${schedule.travel_style}</p>
                <p class="text-sm italic text-gray-600 mb-3">${schedule.summary}</p>
                <ol class="list-decimal pl-5 space-y-3">
                    ${schedule.optimized_itinerary.map(item => `
                        <li class="font-semibold text-gray-800">
                            ${item.spot_name}
                            <p class="text-xs text-gray-500 font-normal">åŸå› : ${item.recommendation_reason}</p>
                        </li>
                    `).join('')}
                </ol>
            `;
            mapElement.innerHTML = summaryHTML;
            document.getElementById('spotDetail').innerHTML = '<p class="text-sm text-gray-500">è«‹åœ¨åœ°åœ–å€æŸ¥çœ‹ AI ç”Ÿæˆçš„æœ€ä½³å‹•ç·šã€‚</p>';
        }

        document.getElementById('validateApiKey').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusText = document.getElementById('apiStatus');
            
            if (!apiKey) {
                statusText.textContent = 'âŒ è«‹è¼¸å…¥ API Keyã€‚';
                statusText.style.color = 'red';
                return;
            }

            statusText.textContent = 'â³ æ­£åœ¨é©—è­‰ Key...';
            statusText.style.color = 'orange';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "ping" }] }],
                        config: { maxOutputTokens: 1 }
                    })
                });

                if (response.ok || response.status === 400) { 
                    config.apiKey = apiKey;
                    saveConfig();
                    statusText.textContent = 'âœ… API Key é©—è­‰æˆåŠŸä¸¦å·²å„²å­˜ï¼';
                    statusText.style.color = 'green';
                    if (config.currentCityKey) {
                        fetchWeatherForecast();
                        fetchCityRecommendations();
                    }
                } else {
                    throw new Error('é©—è­‰å¤±æ•—');
                }
            } catch (error) {
                statusText.textContent = `âŒ API Key é©—è­‰å¤±æ•—: ${error.message}`;
                statusText.style.color = 'red';
                console.error('API Key validation failed:', error);
            }
        });
    </script>
</body>
</html>
